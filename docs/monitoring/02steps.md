# 监控系统的搭建步骤

上一篇带大家认识了什么是前端监控系统，前端监控系统的意义和作用，以及这本小册能学到什么。这一篇我们从章节总览的角度出发，看一下具体步骤怎么设计。

在开始上手之前，我们还应该系统性的思考一下，前端监控应该怎么搭建？具体的流程步骤有哪些？因为本小册的前端监控系统是一个全栈项目，涉及的内容比较多，前后端数据库通知服务等一应俱全。所以小册的内容根据功能划分为几个阶段，每个阶段再包含几个章节，层层递进，讲起来会比较明确一些。

小册的整体划分阶段如下：

1. 采集阶段：数据采集
2. API 阶段：搭建 API 应用
3. 数据库阶段：API 对接数据库
4. 实战阶段：采集到的数据统计分析
5. 可视化阶段：前端对统计数据做可视化
6. 报警阶段：对接报警通知
7. 部署阶段：应用整体部署上线

### 采集阶段：要采集哪些数据？

做监控的第一步就是采集数据，有真实数据是后面做分析的基础。采集数据的意义就是记录用户在使用产品过程中的真实操作，结合上一篇我们的分析，真实操作最关键的就是`异常数据`和`行为数据`，本小册主要是采集的数据就是这两个部分，可以为后期的统计和追踪做准备。

我们先分析一下异常数据。项目中的异常总体可以分为两大类，一类是`前端异常`，一类是`接口异常`。前端异常总结起来大概分为：

- js 代码执行异常
- Promise 异常
- 静态资源加载异常
- console.error 异常
- 跨域异常

其中最重要的，也是我们遇到最多的，就是各种各样的 js 代码执行异常。比如类型错误，引用错误等等，这些异常大多是我们编码不严谨导致的，因此收集此类异常有利于我们改进编码质量。然后就是 Promise 异常，Promise 是 ES6 最重要的属性之一，考验我们的 js 异步编程能力，集中体现在接口请求上面，因此这两部分的异常捕获非常关键。

除此之外，静态资源加载异常，一般指在 html 中引用一些图片地址，第三方 js 地址等，各种原因不能正常加载了，这个也要监听的到；console.error 异常，一般是在用某个第三方前端框架，他里面自定义了一些错误，会用 `console.error` 抛出来，这类异常也有捕获的必要性。

至于跨域异常，这个我们常常碰到，一般在前后端开发时的联调阶段就能发现。不过也保不定后端在线上突然改了什么配置，导致前端跨域，为了安全这个也要监听一下。

前端的异常采集大概就这 5 种吧，基本囊括了前端 90% 以上的异常情况。

接口异常属于后端的异常，但是接口异常会直接导致前端页面错误，因此这类异常是我们判断线上问题根源的重要依据。接口异常可以根据响应结果分类：

- 未响应/超时响应异常
- 4xx 请求异常
- 5xx 服务器异常
- 权限不足

有时候因为网络问题或者服务器问题，前端在发起请求之后迟迟未收到响应，请求被挂起，这种时候就属于未响应/超时响应异常。除此之外，其他类型的接口异常我们就可以根据 `http 状态码` 或者后端返回的指定字段如 `error_code` 来判断。

不管是用状态码还是其他判断方式，只要能区分异常类型就可以。4xx 异常类型是请求异常，一般是前端传递的参数问题，或者接口验证参数的问题。处理这类异常的关键是保存请求参数，可以方便前端排错。5xx 错误是服务器内部处理的异常，这类异常的关键信息是报错时间，以及返回的异常说明，将这些保存下来，可以方便后端去查找日志。

权限不足我觉得也是一类重要的错误。因为现在某些管理系统的权限设计比较复杂，有时候突然莫名其妙的接口调不通，影响用户的下一步操作，这也需要记录和追踪。

虽然这里只列出了最通用三类，但是自研监控系统的一大优点就是灵活。如果你的业务场景有更复杂的异常情况，那么你完全可以自由发挥，从自己业务的实际情况出发，设计出更适合自己的异常分类，只要终极目标是可以帮我们更好的追踪和快速解决问题就可以。

这个阶段非常关键，是监控系统设计的核心，所以我写的比较细，大家在这个阶段关于采集哪些数据也要多多考虑。而后面的阶段，则都是基于此设计的具体实现。

### API 阶段：搭建上报数据的 API 接口

上一阶段做好了采集数据的方案，当采集到数据之后，接下来就要将数据上报。数据上报说白了就是通过调用一个 API 接口将这些数据传过去然后存在数据库中，因此本阶段的任务就是搭建上报数据的 API 接口应用。

作为一名光荣的前端工程师，开发接口，自然要选择同属 JS 家族的 Node.js。Node.js 目前的框架也比较多，考虑到本小册的主旨是从 0 到 1，所以除了实现接口功能，更重要的还是和大家从基础开始边学习边搭建的过程。因此我们不会选择大而全的框架，用最简单的 Express 框架即可。

这个阶段主要做三件事情，如下：

- 搭建 API 架构
- 数据库对接
- 查询与统计

搭建 API 架构包括目录结构设计，路由设计，鉴权认证，参数验证，请求响应封装，错误处理等等。这个阶段对后端基础薄弱的同学来说，是非常好的学习时机。因为学习完这个部分你会明白 API 架构是怎么搭建起来的，每个部分为什么要这么做，能解决什么问题，这样你的后端基础知识就会建立起来了。

本篇开头描述到，API 阶段后面还有一个数据库阶段，其实这个阶段是 API 架构搭建好之后连接数据库的操作。因为大多数前端同学对数据库可能不太熟悉，所以单独拎出来一个阶段做数据库介绍，本质上这个阶段还是属于 API 的阶段。

数据库的话，就选对前端最友好的，属于 NoSQL 家族的文档数据库 MongoDB。这个数据库最大的特点是，存储的数据格式类似于 JSON，操作起来就像在 JS 中调用函数，组合 JOSN 数据一样，对我们前端理解和入门非常容易，后面在实战中你就能体会到它的优雅了。

数据库阶段，主要介绍数据库的基本信息和操作，比如怎么连接，怎么设计字段，怎么做验证，怎么写入和查询等等。这一部分掌握了，我们才能把接口接收到的参数存到数据库，并且供后续查询。

当我们搭建好 API 架构，对 Express 熟悉了七七八八，并且数据库知识也可以胸有成竹的时候，我们就是万事俱备，只缺实战了。下一个阶段就是用上述学到的知识，搭建我们真实的监控系统 API 接口。

### 实战阶段：真实的监控 API 接口

API 阶段做的比较多的还是知识介绍与框架搭建，实战篇就要开始写真实的业务接口了。

业务接口分两个大部分开发。第一部分主要是 `新增` 接口，在采集阶段收集到的数据，要通过新增接口将这些数据存到数据库。当然新增接口验证要严格，需要确保进入数据库的数据是可靠的。

除了新增接口，还有很少的情况需要更新接口，比如想要计算页面的停留时间，需要在用户离开时更新某条记录，这样之后再能统计页面停留时间。

第二部分就是整个监控 API 的大头了，对数据做`统计分析`，基本上都是“查询”的操作。这里的查询不单单只是查一下，具体怎么查，关系到了我们搜集的数据能否有效利用。我的思路还是从这两个方面入手：

- `行为数据`：整体统计查询，看某个时间段的趋势
- `异常数据`：单条查询，精确定位，排查具体的错误

当然了这只是从总体来说。行为数据也会单条查询，比如我要看某个时间某个用户做了什么操作，这就属于精确查找。异常数据也有统计，比如异常接口触发频率的排行等。

行为数据的数据量会非常大，在用户使用系统的过程中会频繁产生然后频繁被写入数据库。因此这类数据绝大多数情况是通过 `聚合查询` 的方式从页面，时间等多个维度做总体统计，最后得出一些百分比的结论。这些统计值可以大致反应出产品的实际使用情况。

异常数据对开发人员来说非常重要，是我们定位和解决 bug 的神辅助。不同于行为数据的多条统计，异常数据我们更关心单独每一条记录的详细信息，方便我们一目了然的看到错误。异常数据查询也比较简单，和普通的列表查询一样，返回最新的异常数据即可。当然了我们排查问题之后，还应该对处理好的异常标记为已处理，这样可以防止重复排查。

可以看出，这个阶段最主要的还是做统计接口，为下个阶段可视化图表展示做准备。

### 可视化阶段：最终的数据图表展现

上一个阶段我们开发了统计接口，查出了想要的数据结果，可惜这些结果只能程序员看懂，别人恐怕是看不懂。所以最终为了更直观的反应数据，我们要用前端可视化图表的方式，让这些数据活起来。

在这个阶段，我们终于回到了最熟悉的前端领域。那本阶段的任务相对来说也简单顺手，基于 React 搭建一个新的前端应用，接入上一步的统计接口，再集成前端图表库，将统计结果用图表展现出来。这个新应用是真正要对外展示的前端监控系统，给团队内部的开发或产品同学使用，这样他们可以实时查看产品生成的数据信息。

搭建前端应用框架不准备花太多时间，用一个标准的 React 脚手架生成项目就可以。但是初始化的项目功能不完整，我们还要修补修补，配置一些通用功能，如路由，UI 框架，封装 axios 等。然后迅速进入前端业务功能开发。

这一阶段其实没什么关键问题要讲，主要就是选择一个好用的图表库，对接接口。还有图表的种类多种多样，要考虑哪些数据适合哪种图表，结合实际判断一下。

最后，监控系统的前端页面和接口数据肯定不能所有人都看，所以还要有基础的登录页面和功能。做到这里，本阶段的任务就结束了。

### 报警阶段：发现异常马上报警通知

上一阶段，监控系统前端搭建完成，并将统计数据展现为图表之后，整个监控系统就基本可用了。

但是还有一种情况，就是用户使用我们的产品突然报错了，错误信息也被写入了数据库。如果此时你没有主动刷新页面，事实上你也不可能一直刷新，那么这条错误我们是根本不知道的。如果这是一个很致命的 bug，影响很广泛，Bug 发生我们竟然不知道，这就会给我们造成很大的损失。

所以呢，为了保证我们及时的解决 Bug，一个报警通知的功能就非常重要了。它的作用是在异常发生时，第一时间推送给开发人员，这样大家才能立即发现问题，然后用最快的速度去解决，避免遗漏。

报警通知，一般现在通用的方案是对接钉钉或者是企业微信的机器人，我们这里使用钉钉。具体用哪个平台还得看你的主体在哪个平台。比如我的团队的主体在钉钉，那么在发送报警通知时，可以直接用手机号来 @ 你的任意组员，实现更精准的提醒。

这一部分是 API 实战的补充，申请钉钉开发者权限之后，在 API 中接入相关代码。

### 部署阶段：万事俱备只等上线

前面的几个阶段，我们完成了数据采集，API 应用搭建，数据存储，前端可视化展现，以及监控报警，整个前端监控系统的功能就全部完备了。最后一步就是将前后端数据库全部部署上线，供大家访问。

部署这块主要是 nginx 解析，https 配置，数据库安装，和 nodejs 的应用部署等，这个阶段的内容会偏运维一些。不过别担心，这里我也会对关键操作做详细介绍。

当这个系统上线以后，你就可以尝试在你的任意一个前端项目，根据第一篇的采集方法，将采集到的数据通过 API 保存，然后就可以登入监控系统查看真实的使用数据了。

在这里也鼓励大家坚持学习到最后一章，你一定会有不小的收获。

### 总结

本篇介绍了前端监控系统的搭建过程，将整体流程划分为几个阶段，简述了每个阶段要做什么事情，以及关键问题是什么，帮你理清这本小册的书写思路。

阅读完本篇，相信你对搭建前端监控系统的大概步骤已经心中有数了。不过我还要提醒一下，每个阶段都与下一个阶段环环相扣，因此切记要按照阶段顺序学习，不可以跳章节，否则你的思路很可能会前后不衔接，不利于进一步学习。

从下一篇开始，我们就要进入实际开发的环节了，我会按照上面列出的阶段顺序逐篇介绍。想必大家此刻心中也有一副清晰的进度条了，话不多说，我们继续推进吧～
